<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardQuery">
    
	<select id="boardList" resultType="hashmap">
		SELECT /* boardQuery.boardList */
			*
		FROM BG_BOARD_MASTER
		WHERE 1=1
		AND USE_YN = 'Y'		
		<if test="board_type != null and board_type != ''">
			AND BOARD_TYPE = #{board_type}
		</if>
	</select>
	
	<select id="contentsListByBoardId" resultType="hashmap">
	    SELECT @RNUM := @RNUM + 1 AS ROWNUM, t.*
			FROM(
				SELECT /* boardQuery.contentsListByBoardId */
					BBC.CONTENTS_ID
					, BBC.MEMBER_ID
					, BBC.TITLE
					, BBC.REG_DT
					, BBC.CONTENTS_CODE
					, BBC.EVENT_START_DT
					, BBC.EVENT_END_DT
					, BBC.SUB_CONTENTS
					, BBC.HITS
					, ifnull(BBC.STATUS, 1) AS STATUS
					, CASE (STATUS)
						WHEN 0 THEN '준비중'  
						WHEN 1 THEN '진행중'  
						WHEN 2 THEN '완료'
						ELSE '준비중'
						END  AS STATUS_DESC
					, (SELECT REG_DT  
						FROM BG_BOARD_COMMENTS 
					   WHERE CONTENTS_ID = BBC.CONTENTS_ID
					   LIMIT 1
						) AS COMMENT_REG_DT
					, if(
						(SELECT COUNT(*)
						FROM BG_BOARD_COMMENTS WHERE CONTENTS_ID = BBC.CONTENTS_ID) > 0, 'Y', 'N'
					  ) AS COMMENT_YN
				FROM BG_BOARD_CONTENTS BBC
				WHERE 1=1
				AND BBC.BOARD_ID = #{board_id}
				<if test="search_type == 'title'">
					AND ( BBC.TITLE LIKE CONCAT('%', #{search}, '%'))
				</if>
				<if test="comment_yn !=null and comment_yn !=''">
				    <if test="comment_yn == 'Y'">
				       AND (SELECT COUNT(*)
						FROM BG_BOARD_COMMENTS WHERE CONTENTS_ID = BBC.CONTENTS_ID) > 0 
				    </if>
				    <if test="comment_yn == 'N'">
				       AND (SELECT COUNT(*)
						FROM BG_BOARD_COMMENTS WHERE CONTENTS_ID = BBC.CONTENTS_ID) = 0 
				    </if>
				</if>
				<if test="search_start_date !=null and search_start_date !=''">
					AND DATE_FORMAT(BBC.REG_DT,'%Y%m%d') <![CDATA[ >= ]]> #{search_start_date} 
				</if>
				<if test="search_end_date !=null and search_end_date !=''">
					AND DATE_FORMAT(BBC.REG_DT,'%Y%m%d') <![CDATA[ <= ]]> #{search_end_date}
				</if>
				ORDER BY BBC.CONTENTS_ID ASC
				<if test="startNo != null and perPage != null">
					LIMIT #{startNo}, #{perPage}
				</if>
			) t, ( SELECT @RNUM := 0 ) R
		ORDER BY @RNUM DESC	
	</select>
	<select id="contentsTotalCount" resultType="int">
		SELECT /* boardQuery.contentsTotalCount */
			COUNT(BBC.CONTENTS_ID)
		FROM BG_BOARD_CONTENTS BBC
		WHERE 1=1
		AND BBC.BOARD_ID = #{board_id}
		<if test="search_type == 'title'">
			AND ( BBC.TITLE LIKE CONCAT('%', #{search}, '%'))
		</if>
		<if test="comment_yn !=null and comment_yn !=''">
		    <if test="comment_yn == 'Y'">
		       AND (SELECT COUNT(*)
				FROM BG_BOARD_COMMENTS WHERE CONTENTS_ID = BBC.CONTENTS_ID) > 0 
		    </if>
		    <if test="comment_yn == 'N'">
		       AND (SELECT COUNT(*)
				FROM BG_BOARD_COMMENTS WHERE CONTENTS_ID = BBC.CONTENTS_ID) = 0 
		    </if>
		</if>
		<if test="search_start_date !=null and search_start_date !=''">
			AND DATE_FORMAT(BBC.REG_DT,'%Y%m%d') <![CDATA[ >= ]]> #{search_start_date} 
		</if>
		<if test="search_end_date !=null and search_end_date !=''">
			AND DATE_FORMAT(BBC.REG_DT,'%Y%m%d') <![CDATA[ <= ]]> #{search_end_date}
		</if>
	</select>
	
	<select id="contentsDetail" resultType="hashmap">
	    SELECT /* boardQuery.contentsDetail */
			BBC.CONTENTS_ID
			, BBC.TITLE
			, BBC.CONTENTS
			, BBC.CONTENTS_CODE
			, BBC.SUB_CONTENTS
			, BBC.HITS
			, BBC.IMG_PATH
			, CASE (BBC.STATUS)
				WHEN 0 THEN '준비'  
				WHEN 1 THEN '진행중'  
				WHEN 2 THEN '완료'
			  	ELSE '준비'
			  END  AS STATUS_DESC
			, BBC.EVENT_START_DT
			, BBC.EVENT_END_DT
			, ifnull(BBC.STATUS, 1) AS STATUS
			, BM.MEMBER_ID
			, BM.MEMBER_NM
			, BM.MEMBER_EMAIL
			, BM.MEMBER_CEL
		FROM BG_BOARD_CONTENTS BBC, BG_MEMBER BM
		WHERE 1=1
		AND BBC.MEMBER_ID = BM.MEMBER_ID
		AND BBC.CONTENTS_ID = #{board_contents_id}
	</select>
	
	<select id="commentList" resultType="hashmap">
	    SELECT /* boardQuery.commentList */
	    	*
	    FROM BG_BOARD_COMMENTS
	    WHERE 1=1
	    AND DEL_YN = 'N'
	    AND CONTENTS_ID = #{board_contents_id}
	    ORDER BY COMMENT_ID DESC
	</select>
	
	<select id="commentDetail" resultType="hashmap">
	    SELECT /* boardQuery.commentDetail */
	    	*
	    FROM BG_BOARD_COMMENTS
	    WHERE 1=1
	    AND DEL_YN = 'N'
	    AND COMMENT_ID = #{comment_id}
	</select>
	
	<insert id="addComment">
	    INSERT INTO BG_BOARD_COMMENTS(
			CONTENTS_ID
			, MEMBER_ID
			, COMMENT
	    )
	    VALUES(
			#{board_contents_id}
			, #{member_id}
			, #{comment}	    
	    )
	</insert>
	
	<insert id="addContents">
	    INSERT INTO BG_BOARD_CONTENTS(
			BOARD_ID
			, MEMBER_ID
			, TITLE
			, CONTENTS
			, IMG_PATH
			, CONTENTS_CODE
			, EVENT_START_DT
			, EVENT_END_DT
			, SUB_CONTENTS
			, STATUS
	    )
	    VALUES(
	    	#{board_id}
			, #{member_id}
			, #{title}
			, #{contents}	    
			, #{img_path}	    
			, #{contents_code}	    
			, #{event_start_dt}
			, #{event_end_dt}
			, #{sub_contents}
			, #{status}
	    )
	</insert>
	
	<update id="modifyComment">
	    UPDATE BG_BOARD_COMMENTS
	    SET 
	    	COMMENT = #{comment}
	    WHERE 1=1
	    AND COMMENT_ID = #{comment_id}
	    AND MEMBER_ID = #{member_id}
	</update>
	
	<update id="modifyContents">
	    UPDATE BG_BOARD_CONTENTS
	    SET 
	    	TITLE = #{title}
	    	, CONTENTS = #{contents}
	    	, MOD_DT = now()
	    	, IMG_PATH = #{img_path}
			, CONTENTS_CODE = #{contents_code}	    
			, SUB_CONTENTS = #{sub_contents}
			, STATUS = #{status}
	    WHERE 1=1
	    AND CONTENTS_ID = #{board_contents_id}
	    AND MEMBER_ID = #{member_id}
	</update>
	
	<delete id="deleteComment">
	    DELETE FROM BG_BOARD_COMMENTS
	    WHERE 1=1
	    AND MEMBER_ID = #{member_id}
	    AND COMMENT_ID = #{comment_id}
	</delete>
	
	<delete id="deleteCommentByContentsId">
	    DELETE FROM BG_BOARD_COMMENTS
	    WHERE 1=1
	    AND MEMBER_ID = #{member_id}
	    AND CONTENTS_ID = #{board_contents_id}
	</delete>
	
	<delete id="deleteContents">
	    DELETE FROM BG_BOARD_CONTENTS
	    WHERE 1=1
	    AND MEMBER_ID = #{member_id}
	    AND CONTENTS_ID = #{board_contents_id}
	</delete>
	
</mapper>
